### ============================================
### CONFIGURATION & VARIABLES
### ============================================

@base_url = http://localhost:8000/api
@test_phone = +33612345678  # âš ï¸ REMPLACE par TON VRAI NUMÃ‰RO
@test_country = +33

# Ces variables seront mises Ã  jour automatiquement
@session_key = {{send_code.response.body.session_key}}
@request_id = {{send_code.response.body.request_id}}
@user_id = {{verify_code.response.body.user.id}}

### ============================================
### 1. TESTS D'ENVOI DE CODE (PHONE AUTH)
### ============================================

### TEST 1.1: Envoi code - PremiÃ¨re fois (Register)
# @name send_code
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: register_first_time

{
  "phone_number": "{{test_phone}}",
  "country_code": "{{test_country}}"
}

> {%
  client.test("1.1 - Register First Time", function() {
    client.assert(response.status === 200, "Status devrait Ãªtre 200");
    client.assert(response.body.success === true, "success devrait Ãªtre true");
    client.assert(response.body.action === "register", "action devrait Ãªtre 'register'");
    client.assert(response.body.session_key, "session_key manquante");
    client.assert(response.body.request_id, "request_id manquant");
    client.assert(response.body.user_exists === false, "user_exists devrait Ãªtre false");
    client.log("âœ… Test 1.1 PASS - Session crÃ©Ã©e: " + response.body.session_key);
  });
%}

### TEST 1.2: Envoi code - NumÃ©ro dÃ©jÃ  existant (Login)
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: login_existing_user

{
  "phone_number": "{{test_phone}}",
  "country_code": "{{test_country}}"
}

> {%
  client.test("1.2 - Login Existing User", function() {
    client.assert(response.status === 200, "Status devrait Ãªtre 200");
    client.assert(response.body.action === "login", "action devrait Ãªtre 'login'");
    client.assert(response.body.user_exists === true, "user_exists devrait Ãªtre true");
    client.assert(response.body.user, "infos utilisateur manquantes");
    client.log("âœ… Test 1.2 PASS - Login initiÃ©");
  });
%}

### TEST 1.3: Envoi code - Format invalide (sans +)
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: invalid_format_no_plus

{
  "phone_number": "0612345678",  # Mauvais format
  "country_code": "33"
}

> {%
  client.test("1.3 - Invalid Format (no +)", function() {
    client.assert(response.status === 400, "Status devrait Ãªtre 400");
    client.assert(response.body.phone_number, "Erreur de validation manquante");
    client.log("âœ… Test 1.3 PASS - Validation fonctionne");
  });
%}

### TEST 1.4: Envoi code - NumÃ©ro invalide
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: invalid_phone_number

{
  "phone_number": "+33000000000",  # NumÃ©ro qui n'existe pas
  "country_code": "+33"
}

> {%
  client.test("1.4 - Invalid Phone Number", function() {
    // Soit 400 (validation Django), soit 200 avec Ã©chec Didit
    if (response.status === 200) {
      client.assert(response.body.success === false, "Didit devrait Ã©chouer");
      client.assert(response.body.status === "Invalid", "Status devrait Ãªtre 'Invalid'");
    }
    client.log("âœ… Test 1.4 PASS - Gestion numÃ©ro invalide");
  });
%}

### TEST 1.5: Envoi code - Sans country_code
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: missing_country_code

{
  "phone_number": "+33612345678"
  // Pas de country_code
}

> {%
  client.test("1.5 - Missing Country Code", function() {
    client.assert(response.status === 200, "Devrait fonctionner avec dÃ©faut +33");
    client.assert(response.body.success === true, "Devrait rÃ©ussir avec valeur par dÃ©faut");
    client.log("âœ… Test 1.5 PASS - Country code optionnel");
  });
%}

### ============================================
### 2. TESTS DE VÃ‰RIFICATION OTP
### ============================================

### TEST 2.1: VÃ©rification - Code correct (Register flow)
# âš ï¸ REMPLACE "123456" par le VRAI code reÃ§u par SMS
# âš ï¸ ATTENDS le SMS avant d'exÃ©cuter ce test!
# @name verify_code
POST {{base_url}}/auth/verify/
Content-Type: application/json
X-Test-Case: verify_correct_code_register

{
  "phone_number": "{{test_phone}}",
  "code": "123456",  # âš ï¸ REMPLACE ICI
  "request_id": "{{request_id}}"
}

> {%
  client.test("2.1 - Verify Correct Code (Register)", function() {
    if (response.status === 200) {
      client.assert(response.body.success === true, "success devrait Ãªtre true");
      client.assert(response.body.action === "register", "action devrait Ãªtre 'register'");
      client.assert(response.body.user.kyc_status === "unverified", "KYC devrait Ãªtre 'unverified'");
      client.assert(response.body.user.is_verified === false, "is_verified devrait Ãªtre false");
      client.log("âœ… Test 2.1 PASS - Compte crÃ©Ã© avec KYC unverified");
    } else {
      client.log("âš ï¸ Code incorrect ou Didit non configurÃ©");
    }
  });
%}

### TEST 2.2: VÃ©rification - Code incorrect
POST {{base_url}}/auth/verify/
Content-Type: application/json
X-Test-Case: verify_wrong_code

{
  "phone_number": "{{test_phone}}",
  "code": "000000",  # Code faux intentionnellement
  "request_id": "{{request_id}}"
}

> {%
  client.test("2.2 - Verify Wrong Code", function() {
    client.assert(response.status === 400, "Status devrait Ãªtre 400");
    client.assert(response.body.error, "Message d'erreur manquant");
    client.assert(response.body.code === "invalid_otp", "Code erreur devrait Ãªtre 'invalid_otp'");
    client.log("âœ… Test 2.2 PASS - Code incorrect rejetÃ©");
  });
%}

### TEST 2.3: VÃ©rification - Mauvais request_id
POST {{base_url}}/auth/verify/
Content-Type: application/json
X-Test-Case: verify_wrong_request_id

{
  "phone_number": "{{test_phone}}",
  "code": "123456",
  "request_id": "fake-request-id-123"
}

> {%
  client.test("2.3 - Verify Wrong Request ID", function() {
    client.assert(response.status === 400, "Status devrait Ãªtre 400");
    client.log("âœ… Test 2.3 PASS - Request ID invalide dÃ©tectÃ©");
  });
%}

### TEST 2.4: VÃ©rification - DonnÃ©es manquantes
POST {{base_url}}/auth/verify/
Content-Type: application/json
X-Test-Case: verify_missing_data

{
  "phone_number": "{{test_phone}}"
  // Pas de code, pas de request_id
}

> {%
  client.test("2.4 - Verify Missing Data", function() {
    client.assert(response.status === 400, "Status devrait Ãªtre 400");
    client.assert(response.body.code, "Erreur de validation manquante");
    client.assert(response.body.request_id, "Erreur request_id manquante");
    client.log("âœ… Test 2.4 PASS - Validation des donnÃ©es");
  });
%}

### TEST 2.5: VÃ©rification - Code dÃ©jÃ  utilisÃ© (Login flow)
# ExÃ©cute d'abord 1.2 pour avoir un nouveau code
# Puis exÃ©cute celui-ci avec le nouveau code
POST {{base_url}}/auth/verify/
Content-Type: application/json
X-Test-Case: verify_correct_code_login

{
  "phone_number": "{{test_phone}}",
  "code": "123456",  # âš ï¸ REMPLACE par NOUVEAU code SMS
  "request_id": "{{request_id}}"
}

> {%
  client.test("2.5 - Verify Correct Code (Login)", function() {
    if (response.status === 200) {
      client.assert(response.body.action === "login", "action devrait Ãªtre 'login'");
      client.assert(response.body.user.id === user_id, "MÃªme utilisateur devrait Ãªtre retournÃ©");
      client.log("âœ… Test 2.5 PASS - Login rÃ©ussi");
    }
  });
%}

### ============================================
### 3. TESTS DE SESSION & STATUT
### ============================================

### TEST 3.1: VÃ©rifier statut session valide
GET {{base_url}}/auth/status/?session_key={{session_key}}
Content-Type: application/json
X-Test-Case: check_valid_session

> {%
  client.test("3.1 - Check Valid Session", function() {
    client.assert(response.status === 200, "Status devrait Ãªtre 200");
    client.assert(response.body.authenticated === true, "Devrait Ãªtre authentifiÃ©");
    client.assert(response.body.session, "DonnÃ©es session manquantes");
    client.log("âœ… Test 3.1 PASS - Session valide");
  });
%}

### TEST 3.2: VÃ©rifier statut session expirÃ©e
GET {{base_url}}/auth/status/?session_key=expired_session_123
Content-Type: application/json
X-Test-Case: check_expired_session

> {%
  client.test("3.2 - Check Expired Session", function() {
    client.assert(response.status === 200, "Status devrait Ãªtre 200");
    client.assert(response.body.authenticated === false, "Ne devrait pas Ãªtre authentifiÃ©");
    client.assert(response.body.message === "Session expirÃ©e", "Message d'expiration incorrect");
    client.log("âœ… Test 3.2 PASS - Session expirÃ©e dÃ©tectÃ©e");
  });
%}

### TEST 3.3: VÃ©rifier statut sans session_key
GET {{base_url}}/auth/status/
Content-Type: application/json
X-Test-Case: check_no_session

> {%
  client.test("3.3 - Check No Session", function() {
    client.assert(response.status === 200, "Status devrait Ãªtre 200");
    client.assert(response.body.authenticated === false, "Ne devrait pas Ãªtre authentifiÃ©");
    client.log("âœ… Test 3.3 PASS - Pas de session gÃ©rÃ©");
  });
%}

### ============================================
### 4. TESTS D'ERREURS DIDIT SIMULÃ‰ES
### ============================================

### TEST 4.1: Simuler erreur 401 - ClÃ© API invalide
# Ce test nÃ©cessite de modifier temporairement settings.py
# DIDIT_API_KEY = "fake-key-123"
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: didit_401_invalid_key

{
  "phone_number": "{{test_phone}}",
  "country_code": "{{test_country}}"
}

> {%
  client.test("4.1 - Didit 401 Invalid Key", function() {
    if (response.status === 400) {
      client.assert(response.body.status === "Unauthorized", "Devrait Ãªtre 'Unauthorized'");
      client.log("âœ… Test 4.1 PASS - 401 gÃ©rÃ© correctement");
    }
  });
%}

### TEST 4.2: Simuler erreur 429 - Trop de requÃªtes
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: didit_429_rate_limit

{
  "phone_number": "+33698765432",  # Nouveau numÃ©ro pour test
  "country_code": "+33"
}

> {%
  client.test("4.2 - Didit 429 Rate Limit", function() {
    // RÃ©pÃ¨te cette requÃªte 10x rapidement pour dÃ©clencher le rate limit
    client.log("ExÃ©cute ce test plusieurs fois rapidement");
  });
%}

### ============================================
### 5. TESTS DE SÃ‰CURITÃ‰
### ============================================

### TEST 5.1: Compte dÃ©sactivÃ© - Doit Ã©chouer
# 1. DÃ©sactive l'utilisateur dans l'admin Django
# 2. ExÃ©cute ce test
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: disabled_account

{
  "phone_number": "{{test_phone}}",
  "country_code": "{{test_country}}"
}

> {%
  client.test("5.1 - Disabled Account", function() {
    client.assert(response.status === 403, "Status devrait Ãªtre 403");
    client.assert(response.body.code === "account_disabled", "Code erreur incorrect");
    client.log("âœ… Test 5.1 PASS - Compte dÃ©sactivÃ© bloquÃ©");
  });
%}

### TEST 5.2: Injection SQL potentielle
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: sql_injection_attempt

{
  "phone_number": "+33612345678' OR '1'='1",
  "country_code": "+33"
}

> {%
  client.test("5.2 - SQL Injection Attempt", function() {
    client.assert(response.status === 400, "Devrait Ã©chouer avec 400");
    client.log("âœ… Test 5.2 PASS - Injection bloquÃ©e");
  });
%}

### TEST 5.3: RequÃªte trÃ¨s longue (DoS potentiel)
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: long_input_dos

{
  "phone_number": "+33" + "1".repeat(1000),  # NumÃ©ro trÃ¨s long
  "country_code": "+33"
}

> {%
  client.test("5.3 - Long Input DOS", function() {
    client.assert(response.status === 400, "Devrait Ã©chouer avec 400");
    client.log("âœ… Test 5.3 PASS - Input long rejetÃ©");
  });
%}

### ============================================
### 6. TESTS DE PERFORMANCE
### ============================================

### TEST 6.1: Mesurer temps rÃ©ponse - Envoi code
# @name perf_send_code
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Case: performance_send

{
  "phone_number": "+33699999999",  # Nouveau numÃ©ro
  "country_code": "+33"
}

> {%
  client.test("6.1 - Performance Send Code", function() {
    client.assert(response.status === 200, "Devrait rÃ©ussir");
    client.assert(response.body.success === true, "Devrait rÃ©ussir");
    // Le temps rÃ©ponse est dans les logs du client
    client.log("â±ï¸  Temps rÃ©ponse: " + response.timings.phases.firstByte + "ms");
  });
%}

### TEST 6.2: Mesurer temps rÃ©ponse - VÃ©rification
POST {{base_url}}/auth/verify/
Content-Type: application/json
X-Test-Case: performance_verify

{
  "phone_number": "{{test_phone}}",
  "code": "123456",
  "request_id": "{{request_id}}"
}

> {%
  client.test("6.2 - Performance Verify", function() {
    // VÃ©rifie juste que Ã§a rÃ©pond
    client.assert([200, 400].includes(response.status), "Devrait rÃ©pondre");
    client.log("â±ï¸  Temps rÃ©ponse: " + response.timings.phases.firstByte + "ms");
  });
%}

### ============================================
### WORKFLOW COMPLET - SCÃ‰NARIO RÃ‰EL
### ============================================

### SCÃ‰NARIO: Nouvel utilisateur (Register flow)
# 1. Envoi du code
# @name scenario_register_send
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Scenario: new_user_register

{
  "phone_number": "+33677778888",  # âš ï¸ Utilise un VRAI numÃ©ro que tu possÃ¨des
  "country_code": "+33"
}

> {%
  client.test("Scenario - Register Send", function() {
    client.assert(response.status === 200, "Ã‰chec envoi code");
    client.assert(response.body.action === "register", "Devrait Ãªtre register");
    client.global.set("scenario_request_id", response.body.request_id);
    client.log("ğŸ“± Code envoyÃ©! VÃ©rifie ton SMS");
  });
%}

### 2. VÃ©rification du code (âš ï¸ ATTENDS le SMS)
# @name scenario_register_verify
POST {{base_url}}/auth/verify/
Content-Type: application/json
X-Test-Scenario: new_user_verify

{
  "phone_number": "+33677778888",
  "code": "123456",  # âš ï¸ REMPLACE par VRAI code
  "request_id": "{{scenario_request_id}}"
}

> {%
  client.test("Scenario - Register Verify", function() {
    if (response.status === 200) {
      client.assert(response.body.user.kyc_status === "unverified", "KYC devrait Ãªtre unverified");
      client.assert(response.body.kyc_info.next_step === "complete_profile", "Next step incorrect");
      client.global.set("scenario_user_id", response.body.user.id);
      client.log("ğŸ‰ NOUVEL UTILISATEUR CRÃ‰Ã‰! ID: " + response.body.user.id);
    } else {
      client.log("âŒ Ã‰chec vÃ©rification: " + JSON.stringify(response.body));
    }
  });
%}

### 3. DeuxiÃ¨me connexion (Login flow)
POST {{base_url}}/auth/phone/
Content-Type: application/json
X-Test-Scenario: existing_user_login

{
  "phone_number": "+33677778888",
  "country_code": "+33"
}

> {%
  client.test("Scenario - Login Send", function() {
    client.assert(response.status === 200, "Ã‰chec envoi code login");
    client.assert(response.body.action === "login", "Devrait Ãªtre login");
    client.assert(response.body.user_exists === true, "Utilisateur devrait exister");
    client.log("ğŸ“± Code login envoyÃ©!");
  });
%}